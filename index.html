<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
  <title>Document</title>
  <style>
  .agree-chart {
    position: relative;
    width: 1140px;
  }
  .agree-chart::after{
    border-style: solid;
    border-width: 3px 12px 3px 0;
    border-color: transparent rgb(200, 200, 200) transparent transparent;
    content: ' ';
    width: 0;
    height: 0;
    position: absolute;
    left: -12px;
    bottom: 4px;
  }
  .agree-chart::before{
    border-style: solid;
    border-width: 3px 0 3px 12px;
    border-color: transparent transparent transparent rgb(200, 200, 200);
    content: ' ';
    width: 0;
    height: 0;
    position: absolute;
    right: -12px;
    bottom: 4px;
  }

  .agree-chart svg {
    border-bottom: 6px solid rgb(200, 200, 200);
  }

  .brush .extent {
    opacity: .125
  }
}
  </style>

</head>
<body>
  <div class="agree-chart">
    <svg width="960" height="500"></svg>
  </div>
  <script
  src="http://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v3.js"></script>
  <script type="text/javascript" src="faker.js"></script>
  <script type="text/javascript" src="index.js"></script>
  <script type="text/javascript">

  var array = []

  for(var i = 0; i <= 50; i++) {
    var object = {
      name: faker.name.findName(),
      date: faker.date.future().getTime(),
      sum: Math.floor(Math.random() * (1000 - 1 + 1)) + 1,
      avatar: faker.internet.avatar(),
      id: faker.commerce.product().toLowerCase()
    }
    array.push(object)
  }

  var data = {
    children: array
  }

  var xScale = d3.scale.linear()
    .range([0, 1140]);

  var yScale = d3.scale.linear()
    .range([0, 300]);


  var brush = d3.svg.brush()
    .x(xScale)
    .y(yScale)
    .on("brushstart", brushstart)
    .on("brushend", brushend);

  var width = 1140,
    height = 300,
    color = d3.scale.category20();

  var canvas = d3.select("svg")
    .attr("width", width)
    .attr("height", height)
    .style("position", "relative")
    .attr("class", "bubble-range")


  var pack = d3.layout.pack()
    .size([width, height])
    .padding(2);

  var nodes = pack.nodes(data);

  var bru = d3.select("svg")
  .append("g")
    .attr("class", "brush")
    .call(brush)


  var handle = bru.selectAll(".handle--custom")
    .data([{type: "w"}, {type: "e"}])
    .enter().append("path")
      .attr("class", "handle--custom")
      .attr("fill", "#666")
      .attr("fill-opacity", 0.8)
      .attr("stroke", "#000")
      .attr("stroke-width", 1.5)
      .attr("cursor", "ew-resize")


  var node = canvas.selectAll(".node")
    .data(prepare(nodes))
    .enter()
    .append("g")
    .attr("transform", function(d) {
      return (d.depth !== 0) ? "translate(" + d.x + ", " + d.y + ")" : "translate(" + -999 + ", " + -999 + ")";
    });

    function brushstart(){
      d3.selectAll("circle")
        .classed("highlight", false);
    }

    function brushend(){
        var e = brush.extent();
        d3.selectAll("circle").filter(function(d){
            return xScale(d.x) >= xScale(e[0][0]) &&
                   yScale(d.y) <= yScale(e[0][1]) &&
                   xScale(d.x) <= xScale(e[1][0]) &&
                   yScale(d.y) >= yScale(e[1][1]);
        })
        .classed("highlight", true);
    }

    var defs = node.append("defs")
      .append("svg:pattern")
      .attr("id", function(d) {
        return d.id;
      })
      .attr("width", 20)
      .attr("height", 20)
      .append("svg:image")
      .attr("xlink:href", function(d) {
        return d.avatar
      })
      .attr("width", 20)
      .attr("height", 20)
      .attr("x", 0)
      .attr("y", 0);

    var circle = node.append("circle")
      .attr("r", function(d) { return 0;})
      .attr("cx", 20)
      .attr("cy", 20)
      .attr("fill", function(d) {
        return "url(#" + d.id + ")"
      })
      .attr("r", function (d) { return d.r; })
      .on("mouseover", function(d){
        d3.select($(this).next()[0])
        .style('visibility', 'visible')
      })
     .on("mouseout", function(){
        d3.select($(this).next()[0])
        .style('visibility', 'hidden')
     })
     .on("click", function() {
       d3.selectAll(".brush").call(brush.clear());
     });

     var text = node.append("text")
       .text(function(d) {
         return "lol"
       })
       .style('visibility', 'hidden')

     function prepare(object) {
        for(var key = 0; key < object.length; key++){
            object[key].y = 265
            object[key].x = object[key].sum
            object[key].r = 10
        }
        return object
    }

  </script>
</body>
</html>
